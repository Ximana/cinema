{% extends 'core/base.html' %}

{% block title %}Detalhes do Filme{% endblock %}

{% block arquivos_css %}
<style>
    .nav-tabs .nav-link {
        color: #198754;
        border: none;
        margin-right: 1rem;
        padding: 0.8rem 1.5rem;
        transition: all 0.3s ease;
        border-radius: 0.5rem;
    }

    .nav-tabs .nav-link:hover {
        background-color: #e8f5e9;
    }

    .nav-tabs .nav-link.active {
        color: white;
        background-color: #198754;
        border: none;
    }

    .filme-poster {
        width: 220px;
        height: 320px;
        border-radius: 1rem;
        object-fit: cover;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .filme-card {
        background: white;
        border-radius: 1rem;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
    }

    .filme-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
    }

    .info-label {
        color: #6c757d;
        font-size: 0.9rem;
    }

    .info-value {
        color: #2c3e50;
        font-weight: 500;
    }

    .sessao-card {
        border-radius: 0.8rem;
        border: none;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
    }

    .estatistica-card {
        border-radius: 1rem;
        border: none;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
        transition: all 0.3s ease;
        padding: 1.5rem;
        margin-bottom: 1.5rem;
    }

    .estatistica-card:hover {
        transform: translateY(-3px);
        box-shadow: 0 6px 16px rgba(0, 0, 0, 0.12);
    }

    .stat-number {
        font-size: 2.5rem;
        font-weight: 700;
        color: #198754;
    }

    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
        margin-bottom: 0;
    }

    .trailer-container {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 56.25%;
        /* 16:9 Aspect Ratio */
        overflow: hidden;
        border-radius: 1rem;
    }

    .trailer-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        border: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <!-- Filme Header -->
    <div class="filme-card p-4 mb-4">
        <div class="row align-items-center">
            <div class="col-md-3 text-center">
                {% if filme.poster %}
                <img src="{{ filme.poster.url }}" alt="Poster do Filme" class="filme-poster mb-3">
                {% else %}
                <img src="/media/filmes/poster/filme_padrao.jpg" alt="Poster Padrão" class="filme-poster mb-3">
                {% endif %}
            </div>
            <div class="col-md-7">
                <h2 class="text-success mb-1">{{ filme.titulo }}</h2>
                <p class="text-muted mb-2">Diretor: {{ filme.diretor }}</p>
                <div class="d-flex gap-3 mb-3">
                    <span class="badge bg-success">{{ filme.genero }}</span>
                    <span class="badge bg-success">{{ filme.classificacao }}</span>
                    <span class="badge bg-success">{{ filme.duracao_minutos }} minutos</span>
                </div>
                <p class="mb-2">{{ filme.sinopse|truncatechars:200 }}</p>
                <p class="text-muted"><small>Data de Lançamento: {{ filme.data_lancamento|date:"d/m/Y" }}</small></p>
            </div>
            <div class="col-md-2 text-end">
                <button type="button" data-bs-toggle="modal" data-bs-target="#modalEditarFilme"
                    class="btn btn-outline-success mb-2 w-100">
                    <i class="fas fa-edit me-2"></i>Editar
                </button>
                {% if filme.trailer_oficial_url %}
                <a href="{{ filme.trailer_oficial_url }}" target="_blank" class="btn btn-outline-danger w-100">
                    <i class="fab fa-youtube me-2"></i>Trailer
                </a>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs border-0 mb-4" id="filmeTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="detalhes-tab" data-bs-toggle="tab" data-bs-target="#detalhes"
                type="button" role="tab">
                <i class="fas fa-info-circle me-2"></i>Detalhes
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="sessoes-tab" data-bs-toggle="tab" data-bs-target="#sessoes" type="button"
                role="tab">
                <i class="fas fa-calendar-alt me-2"></i>Sessões
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="estatisticas-tab" data-bs-toggle="tab" data-bs-target="#estatisticas"
                type="button" role="tab">
                <i class="fas fa-chart-bar me-2"></i>Estatísticas
            </button>
        </li>
    </ul>

    <div class="tab-content" id="filmeTabsContent">
        <!-- Detalhes -->
        <div class="tab-pane fade show active" id="detalhes" role="tabpanel">
            <div class="row">
                <div class="col-md-8">
                    <div class="filme-card p-4 mb-4">
                        <h4 class="mb-3 text-success">Informações do Filme</h4>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="info-label">Título</div>
                                    <div class="info-value">{{ filme.titulo }}</div>
                                </div>
                                <div class="mb-3">
                                    <div class="info-label">Diretor</div>
                                    <div class="info-value">{{ filme.diretor }}</div>
                                </div>
                                <div class="mb-3">
                                    <div class="info-label">Gênero</div>
                                    <div class="info-value">{{ filme.genero }}</div>
                                </div>
                                <div class="mb-3">
                                    <div class="info-label">Classificação</div>
                                    <div class="info-value">{{ filme.classificacao }}</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <div class="info-label">Duração</div>
                                    <div class="info-value">{{ filme.duracao_minutos }} minutos</div>
                                </div>
                                <div class="mb-3">
                                    <div class="info-label">Data de Lançamento</div>
                                    <div class="info-value">{{ filme.data_lancamento|date:"d/m/Y" }}</div>
                                </div>
                                <div class="mb-3">
                                    <div class="info-label">Data de Cadastro</div>
                                    <div class="info-value">{{ filme.data_registo|date:"d/m/Y H:i" }}</div>
                                </div>
                                <div class="mb-3">
                                    <div class="info-label">Última Atualização</div>
                                    <div class="info-value">{{ filme.data_atualizacao|date:"d/m/Y H:i" }}</div>
                                </div>
                            </div>
                        </div>

                        <h5 class="mb-3 mt-4 text-success">Sinopse</h5>
                        <p>{{ filme.sinopse }}</p>

                        {% if filme.site_oficial %}
                        <div class="mt-4">
                            <a href="{{ filme.site_oficial }}" target="_blank" class="btn btn-outline-success">
                                <i class="fas fa-external-link-alt me-2"></i>Visitar Site Oficial
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
                <div class="col-md-4">
                    {% if filme.trailer_oficial_url %}
                    <div class="filme-card p-4 mb-4">
                        <h4 class="mb-3 text-success">Trailer Oficial</h4>
                        <div class="trailer-container">
                            <!-- Convertendo a URL do YouTube para embed -->
                            {% if 'youtube.com/watch?v=' in filme.trailer_oficial_url %}
                            {% with filme.trailer_oficial_url|cut:'https://www.youtube.com/watch?v=' as video_id %}
                            <iframe src="https://www.youtube.com/embed/{{ video_id }}" allowfullscreen
                                title="Trailer do filme"></iframe>
                            {% endwith %}
                            {% elif 'youtu.be/' in filme.trailer_oficial_url %}
                            {% with filme.trailer_oficial_url|cut:'https://youtu.be/' as video_id %}
                            <iframe src="https://www.youtube.com/embed/{{ video_id }}" allowfullscreen
                                title="Trailer do filme"></iframe>
                            {% endwith %}
                            {% else %}
                            <a href="{{ filme.trailer_oficial_url }}" target="_blank" class="btn btn-danger">
                                <i class="fab fa-youtube me-2"></i>Assistir Trailer
                            </a>
                            {% endif %}
                        </div>
                    </div>
                    {% endif %}

                    <div class="filme-card p-4">
                        <h4 class="mb-3 text-success">Próximas Sessões</h4>
                        {% if proximas_sessoes %}
                        {% for sessao in proximas_sessoes|slice:":3" %}
                        <div class="card mb-2 border-0 bg-light">
                            <div class="card-body p-3">
                                <div class="d-flex justify-content-between">
                                    <span>{{ sessao.horario|date:"d/m/Y H:i" }}</span>
                                    <span
                                        class="badge {% if sessao.tipo == '3d' %}bg-info{% elif sessao.tipo == 'imax' %}bg-primary{% else %}bg-success{% endif %}">
                                        {{ sessao.get_tipo_display }}
                                    </span>
                                </div>
                                <small class="text-muted">{{ sessao.sala.nome }} - {{ sessao.sala.cinema.nome }}</small>
                                <div class="d-flex justify-content-between align-items-center mt-2">
                                    <span>Kz {{ sessao.preco_base }}</span>
                                    <span class="badge bg-secondary">{{ sessao.get_idioma_display }}</span>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        <div class="text-center mt-3">
                            <button class="btn btn-sm btn-success" id="sessoes-tab-trigger">
                                Ver todas as sessões
                            </button>
                        </div>
                        {% else %}
                        <div class="text-center py-4">
                            <i class="fas fa-calendar-times text-muted fa-2x mb-3"></i>
                            <p class="text-muted">Não há sessões agendadas no momento.</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Sessões -->
        <div class="tab-pane fade" id="sessoes" role="tabpanel">
            <div class="filme-card p-4">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h4 class="text-success mb-0">Sessões Agendadas</h4>
                    <a href="#" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#modalAdicionarSessao">
                        <i class="fas fa-plus me-2"></i>Nova Sessão
                    </a>
                </div>

                <!-- Filtros -->
                <div class="row mb-4">
                    <div class="col-md-4">
                        <div class="input-group">
                            <span class="input-group-text bg-success text-white">
                                <i class="fas fa-calendar"></i>
                            </span>
                            <input type="date" class="form-control" id="filtroData" placeholder="Filtrar por data">
                        </div>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="filtroCinema">
                            <option value="">Todos os Cinemas</option>
                            {% for cinema in cinemas %}
                            <option value="{{ cinema.id }}">{{ cinema.nome }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-4">
                        <select class="form-select" id="filtroTipo">
                            <option value="">Todos os tipos</option>
                            <option value="2d">2D</option>
                            <option value="3d">3D</option>
                            <option value="imax">IMAX</option>
                        </select>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead class="table-success">
                            <tr>
                                <th>Data/Hora</th>
                                <th>Sala</th>
                                <th>Cinema</th>
                                <th>Tipo</th>
                                <th>Idioma</th>
                                <th>Preço Base</th>
                                <th>Capacidade</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for sessao in sessoes %}
                            <tr>
                                <td>{{ sessao.horario|date:"d/m/Y H:i" }}</td>
                                <td>{{ sessao.sala.nome }}</td>
                                <td>{{ sessao.sala.cinema.nome }}</td>
                                <td>
                                    <span
                                        class="badge {% if sessao.tipo == '3d' %}bg-info{% elif sessao.tipo == 'imax' %}bg-primary{% else %}bg-success{% endif %}">
                                        {{ sessao.get_tipo_display }}
                                    </span>
                                </td>
                                <td>{{ sessao.get_idioma_display }}</td>
                                <td>Kz {{ sessao.preco_base }}</td>
                                <td>{{ sessao.sala.capacidade }} lugares</td>
                                <td>
                                    <div class="btn-group">
                                        <a href="{% url 'sessoes:detalhes' pk=sessao.pk %}"
                                            class="btn btn-outline-success btn-sm" data-bs-toggle="tooltip"
                                            data-bs-placement="top" title="Ver detalhes">
                                            <i class="fa fa-eye"></i>
                                        </a>
                                    </div>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="8" class="text-center py-4">
                                    <i class="fas fa-calendar-times text-muted fa-2x mb-3"></i>
                                    <p class="text-muted">Não há sessões agendadas para este filme.</p>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>

                <!-- Paginação -->
                {% if sessoes.has_other_pages %}
                <nav aria-label="Paginação das sessões" class="mt-4">
                    <ul class="pagination justify-content-center">
                        {% if sessoes.has_previous %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ sessoes.previous_page_number }}">Anterior</a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Anterior</span>
                        </li>
                        {% endif %}

                        {% for i in sessoes.paginator.page_range %}
                        {% if sessoes.number == i %}
                        <li class="page-item active">
                            <span class="page-link">{{ i }}</span>
                        </li>
                        {% else %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ i }}">{{ i }}</a>
                        </li>
                        {% endif %}
                        {% endfor %}

                        {% if sessoes.has_next %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ sessoes.next_page_number }}">Próxima</a>
                        </li>
                        {% else %}
                        <li class="page-item disabled">
                            <span class="page-link">Próxima</span>
                        </li>
                        {% endif %}
                    </ul>
                </nav>
                {% endif %}
            </div>
        </div>

        <!-- Estatísticas -->
        <div class="tab-pane fade" id="estatisticas" role="tabpanel">
            <div class="row">
                <div class="col-md-4">
                    <div class="estatistica-card text-center">
                        <i class="fas fa-ticket-alt fa-2x text-success mb-3"></i>
                        <div class="stat-number">{{ total_ingressos }}</div>
                        <p class="stat-label">Ingressos Vendidos</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="estatistica-card text-center">
                        <i class="fas fa-money-bill-wave fa-2x text-success mb-3"></i>
                        <div class="stat-number">Kz {{ receita_total }}</div>
                        <p class="stat-label">Receita Total</p>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="estatistica-card text-center">
                        <i class="fas fa-users fa-2x text-success mb-3"></i>
                        <div class="stat-number">{{ taxa_ocupacao }}%</div>
                        <p class="stat-label">Taxa de Ocupação</p>
                    </div>
                </div>
            </div>

            <div class="filme-card p-4 mb-4">
                <h4 class="mb-4 text-success">Distribuição de Ingressos por Tipo</h4>
                <canvas id="graficoTipoIngressos" width="400" height="200"></canvas>
            </div>

            <div class="row">
                <div class="col-md-6">
                    <div class="filme-card p-4 mb-4">
                        <h4 class="mb-4 text-success">Vendas por Dia da Semana</h4>
                        <canvas id="graficoVendasDiaSemana" width="400" height="250"></canvas>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="filme-card p-4 mb-4">
                        <h4 class="mb-4 text-success">Vendas por Cinema</h4>
                        <canvas id="graficoVendasCinema" width="400" height="250"></canvas>
                    </div>
                </div>
            </div>

            <div class="filme-card p-4">
                <h4 class="mb-4 text-success">Evolução de Vendas Diárias</h4>
                <canvas id="graficoEvolucaoVendas" width="400" height="200"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Modal para editar filme -->
<div class="modal fade" id="modalEditarFilme" tabindex="-1" aria-labelledby="modalEditarFilmeLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="modalEditarFilmeLabel">Editar Filme</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                    aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'filmes:editar' pk=filme.pk %}" enctype="multipart/form-data">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.titulo.id_for_label }}" class="form-label">{{ form.titulo.label
                                    }}</label>
                                {{ form.titulo }}
                                {% if form.titulo.errors %}
                                <div class="text-danger">{{ form.titulo.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="{{ form.diretor.id_for_label }}" class="form-label">{{ form.diretor.label
                                    }}</label>
                                {{ form.diretor }}
                                {% if form.diretor.errors %}
                                <div class="text-danger">{{ form.diretor.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="{{ form.genero.id_for_label }}" class="form-label">{{ form.genero.label
                                    }}</label>
                                {{ form.genero }}
                                {% if form.genero.errors %}
                                <div class="text-danger">{{ form.genero.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="{{ form.classificacao.id_for_label }}" class="form-label">{{
                                    form.classificacao.label }}</label>
                                {{ form.classificacao }}
                                {% if form.classificacao.errors %}
                                <div class="text-danger">{{ form.classificacao.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="{{ form.duracao_minutos.id_for_label }}" class="form-label">{{
                                    form.duracao_minutos.label }}</label>
                                {{ form.duracao_minutos }}
                                {% if form.duracao_minutos.errors %}
                                <div class="text-danger">{{ form.duracao_minutos.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.data_lancamento.id_for_label }}" class="form-label">{{
                                    form.data_lancamento.label }}</label>
                                {{ form.data_lancamento }}
                                {% if form.data_lancamento.errors %}
                                <div class="text-danger">{{ form.data_lancamento.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="{{ form.site_oficial.id_for_label }}" class="form-label">{{
                                    form.site_oficial.label }}</label>
                                {{ form.site_oficial }}
                                {% if form.site_oficial.errors %}
                                <div class="text-danger">{{ form.site_oficial.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="{{ form.trailer_oficial_url.id_for_label }}" class="form-label">{{
                                    form.trailer_oficial_url.label }}</label>
                                {{ form.trailer_oficial_url }}
                                {% if form.trailer_oficial_url.errors %}
                                <div class="text-danger">{{ form.trailer_oficial_url.errors }}</div>
                                {% endif %}
                            </div>
                            <div class="mb-3">
                                <label for="{{ form.poster.id_for_label }}" class="form-label">{{ form.poster.label
                                    }}</label>
                                {{ form.poster }}
                                {% if form.poster.errors %}
                                <div class="text-danger">{{ form.poster.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ form.sinopse.id_for_label }}" class="form-label">{{ form.sinopse.label }}</label>
                        {{ form.sinopse }}
                        {% if form.sinopse.errors %}
                        <div class="text-danger">{{ form.sinopse.errors }}</div>
                        {% endif %}
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-success">Salvar Alterações</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% include 'filmes/sessao/adicionarSessaoModal.html' %}
{% endblock %}

{% block scriptJS %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Persistência da aba ativa
        const activeTab = localStorage.getItem('activeFilmeTab');
        if (activeTab) {
            const tabTrigger = document.querySelector(`button[data-bs-target="${activeTab}"]`);
            if (tabTrigger) tabTrigger.click();
        }

        const tabElements = document.querySelectorAll('button[data-bs-toggle="tab"]');
        tabElements.forEach(tabElement => {
            tabElement.addEventListener('shown.bs.tab', event => {
                localStorage.setItem('activeFilmeTab', event.target.getAttribute('data-bs-target'));
            });
        });

        // Navegação entre abas por botões
        document.getElementById('sessoes-tab-trigger')?.addEventListener('click', function () {
            document.getElementById('sessoes-tab').click();
        });

        // Inicialização de tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl)
        });

        // Gráficos estatísticos
        const ctxTipoIngressos = document.getElementById('graficoTipoIngressos')?.getContext('2d');
        if (ctxTipoIngressos) {
            new Chart(ctxTipoIngressos, {
                type: 'doughnut',
                data: {
                    labels: ['Inteira', 'Estudante', 'Idoso', 'Promocional'],
                    datasets: [{
                        data: [{{ ingressos_inteira }}, {{ ingressos_estudante }}, {{ ingressos_idoso }}, { { ingressos_promocional } }],
        backgroundColor: [
            '#198754',
            '#0dcaf0',
            '#ffc107',
            '#6f42c1'
        ]
    }]
                },
        options: {
        responsive: true,
        plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
            });
        }

    const ctxVendasDiaSemana = document.getElementById('graficoVendasDiaSemana')?.getContext('2d');
    if (ctxVendasDiaSemana) {
        new Chart(ctxVendasDiaSemana, {
            type: 'bar',
            data: {
                labels: ['Segunda', 'Terça', 'Quarta', 'Quinta', 'Sexta', 'Sábado', 'Domingo'],
                datasets: [{
                    label: 'Ingressos Vendidos',
                    data: [{{ vendas_segunda }}, {{ vendas_terca }}, {{ vendas_quarta }},
    { { vendas_quinta } }, { { vendas_sexta } }, { { vendas_sabado } }, { { vendas_domingo } }],
    backgroundColor: '#198754'
                    }]
                },
    options: {
        responsive: true,
            scales: {
            y: {

                beginAtZero: true
            }
        }
    }
            });
        }

    const ctxVendasCinema = document.getElementById('graficoVendasCinema')?.getContext('2d');
    if (ctxVendasCinema) {
        new Chart(ctxVendasCinema, {
            type: 'pie',
            data: {
                labels: [
                    {% for item in vendas_por_cinema %}
                            '{{ item.nome }}'{% if not forloop.last %}, {% endif %}
    {% endfor %}
                    ],
    datasets: [{
        data: [
            {% for item in vendas_por_cinema %}
                                {{ item.total }}{% if not forloop.last %}, {% endif %}
    {% endfor %}
                        ],
    backgroundColor: [
        '#198754',
        '#0dcaf0',
        '#ffc107',
        '#6f42c1',
        '#dc3545',
        '#fd7e14',
        '#20c997'
    ]
                    }]
                },
    options: {
        responsive: true,
            plugins: {
            legend: {
                position: 'bottom'
            }
        }
    }
            });
        }

    const ctxEvolucaoVendas = document.getElementById('graficoEvolucaoVendas')?.getContext('2d');
    if (ctxEvolucaoVendas) {
        new Chart(ctxEvolucaoVendas, {
            type: 'line',
            data: {
                labels: [
                    {% for item in evolucao_vendas %}
                            '{{ item.data|date:"d/m" }}'{% if not forloop.last %}, {% endif %}
    {% endfor %}
                    ],
    datasets: [{
        label: 'Ingressos Vendidos',
        data: [
            {% for item in evolucao_vendas %}
                                {{ item.total }}{% if not forloop.last %}, {% endif %}
    {% endfor %}
                        ],
    borderColor: '#198754',
        backgroundColor: 'rgba(25, 135, 84, 0.1)',
            fill: true,
                tension: 0.4
                    }]
                },
    options: {
        responsive: true,
            scales: {
            y: {
                beginAtZero: true
            }
        },
        plugins: {
            legend: {
                display: false
            }
        }
    }
            });
        }

    // Funcionalidade de filtros para sessões
    const filtroData = document.getElementById('filtroData');
    const filtroCinema = document.getElementById('filtroCinema');
    const filtroTipo = document.getElementById('filtroTipo');

    function aplicarFiltros() {
        const params = new URLSearchParams();

        if (filtroData?.value) {
            params.append('data', filtroData.value);
        }

        if (filtroCinema?.value) {
            params.append('cinema', filtroCinema.value);
        }

        if (filtroTipo?.value) {
            params.append('tipo', filtroTipo.value);
        }

        // Redirecionar com os filtros aplicados
        const url = window.location.pathname + '#sessoes';
        const fullUrl = params.toString() ? `${url}?${params.toString()}` : url;
        window.location.href = fullUrl;
    }

    // Event listeners para os filtros
    filtroData?.addEventListener('change', aplicarFiltros);
    filtroCinema?.addEventListener('change', aplicarFiltros);
    filtroTipo?.addEventListener('change', aplicarFiltros);

    // Preencher filtros com valores da URL
    const urlParams = new URLSearchParams(window.location.search);

    if (urlParams.get('data') && filtroData) {
        filtroData.value = urlParams.get('data');
    }

    if (urlParams.get('cinema') && filtroCinema) {
        filtroCinema.value = urlParams.get('cinema');
    }

    if (urlParams.get('tipo') && filtroTipo) {
        filtroTipo.value = urlParams.get('tipo');
    }

    // Manipulação do formulário de edição
    const formEditar = document.querySelector('#modalEditarFilme form');
    if (formEditar) {
        // Aplicar classes Bootstrap aos campos do formulário
        const campos = formEditar.querySelectorAll('input, textarea, select');
        campos.forEach(campo => {
            if (!campo.classList.contains('form-control') && !campo.classList.contains('form-control-file')) {
                campo.classList.add('form-control');
            }
        });

        // Validação customizada
        formEditar.addEventListener('submit', function (e) {
            const titulo = document.getElementById('id_titulo');
            const diretor = document.getElementById('id_diretor');
            const duracao = document.getElementById('id_duracao_minutos');

            let isValid = true;

            // Remover mensagens de erro anteriores
            document.querySelectorAll('.campo-erro').forEach(el => el.remove());

            if (titulo && titulo.value.trim().length < 2) {
                mostrarErro(titulo, 'O título deve ter pelo menos 2 caracteres.');
                isValid = false;
            }

            if (diretor && diretor.value.trim().length < 2) {
                mostrarErro(diretor, 'O nome do diretor deve ter pelo menos 2 caracteres.');
                isValid = false;
            }

            if (duracao && (duracao.value < 1 || duracao.value > 600)) {
                mostrarErro(duracao, 'A duração deve estar entre 1 e 600 minutos.');
                isValid = false;
            }

            if (!isValid) {
                e.preventDefault();
            }
        });
    }

    function mostrarErro(campo, mensagem) {
        const erro = document.createElement('div');
        erro.className = 'campo-erro text-danger mt-1';
        erro.textContent = mensagem;
        campo.parentNode.appendChild(erro);
        campo.classList.add('is-invalid');
    }

    // Preview da imagem do poster
    const inputPoster = document.getElementById('id_poster');
    if (inputPoster) {
        inputPoster.addEventListener('change', function (e) {
            if (e.target.files && e.target.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    // Criar preview da imagem
                    let preview = document.getElementById('poster-preview');
                    if (!preview) {
                        preview = document.createElement('img');
                        preview.id = 'poster-preview';
                        preview.className = 'img-thumbnail mt-2';
                        preview.style.maxWidth = '150px';
                        preview.style.maxHeight = '200px';
                        inputPoster.parentNode.appendChild(preview);
                    }
                    preview.src = e.target.result;
                };
                reader.readAsDataURL(e.target.files[0]);
            }
        });
    }

    // Animações e efeitos visuais
    const observerOptions = {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    };

    const observer = new IntersectionObserver(function (entries) {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.style.opacity = '1';
                entry.target.style.transform = 'translateY(0)';
            }
        });
    }, observerOptions);

    // Aplicar animação de entrada aos cards de estatísticas
    document.querySelectorAll('.estatistica-card').forEach((card, index) => {
        card.style.opacity = '0';
        card.style.transform = 'translateY(30px)';
        card.style.transition = `opacity 0.6s ease ${index * 0.1}s, transform 0.6s ease ${index * 0.1}s`;
        observer.observe(card);
    });

    // Formatação de números nos gráficos
    Chart.defaults.plugins.tooltip.callbacks.label = function (context) {
        let label = context.dataset.label || '';
        if (label) {
            label += ': ';
        }
        if (context.parsed !== null) {
            label += new Intl.NumberFormat('pt-AO').format(context.parsed);
        }
        return label;
    };

    // Atualização automática de dados (polling a cada 5 minutos)
    let autoUpdateInterval;

    function iniciarAutoUpdate() {
        // Só ativar se estivermos na aba de estatísticas
        const estatisticasTab = document.getElementById('estatisticas');
        if (estatisticasTab && estatisticasTab.classList.contains('show', 'active')) {
            autoUpdateInterval = setInterval(() => {
                // Aqui você pode implementar uma chamada AJAX para atualizar os dados
                console.log('Atualizando dados...');
                // fetch('/api/filme/' + {{ filme.id }} + '/estatisticas/')
                //     .then(response => response.json())
                //     .then(data => atualizarGraficos(data));
            }, 300000); // 5 minutos
        }
    }

    function pararAutoUpdate() {
        if (autoUpdateInterval) {
            clearInterval(autoUpdateInterval);
            autoUpdateInterval = null;
        }
    }

    // Event listeners para controlar o auto-update
    document.getElementById('estatisticas-tab')?.addEventListener('shown.bs.tab', iniciarAutoUpdate);
    document.querySelectorAll('button[data-bs-toggle="tab"]:not(#estatisticas-tab)').forEach(tab => {
        tab.addEventListener('shown.bs.tab', pararAutoUpdate);
    });

    // Limpar intervalo quando sair da página
    window.addEventListener('beforeunload', pararAutoUpdate);

    // Funcionalidade de busca rápida na tabela de sessões
    const searchInput = document.createElement('input');
    searchInput.type = 'text';
    searchInput.className = 'form-control mb-3';
    searchInput.placeholder = 'Buscar sessões...';
    searchInput.id = 'buscaSessoes';

    const tabelaSessoes = document.querySelector('#sessoes table');
    if (tabelaSessoes) {
        tabelaSessoes.parentNode.insertBefore(searchInput, tabelaSessoes);

        searchInput.addEventListener('input', function (e) {
            const termoBusca = e.target.value.toLowerCase();
            const linhas = tabelaSessoes.querySelectorAll('tbody tr');

            linhas.forEach(linha => {
                const texto = linha.textContent.toLowerCase();
                if (texto.includes(termoBusca)) {
                    linha.style.display = '';
                } else {
                    linha.style.display = 'none';
                }
            });
        });
    }
        
    });

    // Função auxiliar para formatar valores monetários
    function formatarMoeda(valor) {
        return new Intl.NumberFormat('pt-AO', {
            style: 'currency',
            currency: 'AOA',
            minimumFractionDigits: 2
        }).format(valor);
    }

    // Função para exportar dados de estatísticas
    function exportarEstatisticas() {
        const dados = {
            filme: '{{ filme.titulo }}',
            total_ingressos: {{ total_ingressos }
    },
    receita_total: { { receita_total } },
    taxa_ocupacao: { { taxa_ocupacao } },
    ingressos_por_tipo: {
        inteira: { { ingressos_inteira } },
        estudante: { { ingressos_estudante } },
        idoso: { { ingressos_idoso } },
        promocional: { { ingressos_promocional } }
    },
    vendas_por_dia: {
        segunda: { { vendas_segunda } },
        terca: { { vendas_terca } },
        quarta: { { vendas_quarta } },
        quinta: { { vendas_quinta } },
        sexta: { { vendas_sexta } },
        sabado: { { vendas_sabado } },
        domingo: { { vendas_domingo } }
    }
        };

    const dataStr = JSON.stringify(dados, null, 2);
    const dataBlob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(dataBlob);

    const link = document.createElement('a');
    link.href = url;
    link.download = `estatisticas_${dados.filme.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.json`;
    link.click();

    URL.revokeObjectURL(url);
    }

    // Adicionar botão de exportação se estivermos na aba de estatísticas
    document.addEventListener('DOMContentLoaded', function () {
        const estatisticasPane = document.getElementById('estatisticas');
        if (estatisticasPane) {
            const exportBtn = document.createElement('button');
            exportBtn.className = 'btn btn-outline-success btn-sm float-end mb-3';
            exportBtn.innerHTML = '<i class="fas fa-download me-2"></i>Exportar Dados';
            exportBtn.onclick = exportarEstatisticas;

            const firstCard = estatisticasPane.querySelector('.row');
            if (firstCard) {
                firstCard.parentNode.insertBefore(exportBtn, firstCard);
            }
        }
    });
</script>
{% endblock %}